# Authentication and Session Tracking Update

This document outlines recent updates to the authentication system and session tracking functionality.

## 1. Logout Functionality Fix

**Issue:** Users were not being redirected to the front page after clicking logout in the dashboard.

**Solution:** The `signOut` function in `useAuth.ts` has been updated to include redirection to the home page after signing out from Supabase:

```typescript
const signOut = async () => {
  try {
    setLoading(true);
    const { error } = await supabase.auth.signOut();
    if (error) throw error;
    setUser(null);
    setProfile(null);
    
    // Redirect to the home page after successful sign out
    window.location.href = '/';
  } catch (err: any) {
    console.error('Error signing out:', err);
    setError(err.message);
  } finally {
    setLoading(false);
  }
};
```

This ensures that when a user clicks logout, they are properly redirected to the front page.

## 2. Session Tracking Implementation

**Issue:** The `user_sessions` table in Supabase was not being populated with user login data.

**Solution:** The `onAuthStateChange` event handler in `useAuth.ts` has been updated to insert a record into the `user_sessions` table when a user logs in:

```typescript
const { data: { subscription } } = supabase.auth.onAuthStateChange(
  async (event: AuthChangeEvent, session: Session | null) => {
    if (session?.user) {
      setUser(session.user);
      await fetchUserProfile(session.user.id);
      
      // Record session in user_sessions table when user signs in
      if (event === 'SIGNED_IN') {
        try {
          // Insert a new record in the user_sessions table
          const { error } = await supabase
            .from('user_sessions')
            .insert({
              user_id: session.user.id,
              // arrival_time and id will be automatically set by the database defaults
            });
            
          if (error) {
            console.error('Error recording user session:', error);
          }
        } catch (err) {
          console.error('Failed to record user session:', err);
        }
      }
    } else {
      setUser(null);
      setProfile(null);
    }
    setLoading(false);
  }
);
```

This ensures that each login is recorded in the sessions table, with the following data:
- `user_id`: The ID of the logged-in user
- `arrival_time`: Automatically set to the current timestamp by the database default
- `id`: Automatically generated by the database using `gen_random_uuid()`

The `ip_address` field is currently not being populated as it would require server-side code to capture the client's IP address securely.

## Next Steps

1. Consider implementing server-side session tracking to capture additional data like IP addresses.
2. Add analytics to track user session duration by updating the `last_seen_at` field in the profiles table.
3. Implement session management features in the admin dashboard to view active sessions.